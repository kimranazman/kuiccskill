---
phase: 01-pattern-storage-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .knowledge/lib/storage.ts
  - .knowledge/lib/search.ts
  - .knowledge/lib/index.ts
autonomous: true

must_haves:
  truths:
    - "Patterns can be saved to disk as validated YAML files"
    - "Patterns can be loaded from disk and validated"
    - "Tag-based search returns matching patterns"
    - "Category-based filtering returns patterns in category"
  artifacts:
    - path: ".knowledge/lib/storage.ts"
      provides: "CRUD operations for patterns"
      exports: ["savePattern", "loadPattern", "deletePattern", "listPatterns"]
    - path: ".knowledge/lib/search.ts"
      provides: "Search and filter functions"
      exports: ["searchByTags", "filterByCategory", "filterByFramework"]
    - path: ".knowledge/lib/index.ts"
      provides: "Public API barrel export"
      exports: ["savePattern", "loadPattern", "searchByTags", "filterByCategory", "Pattern"]
  key_links:
    - from: ".knowledge/lib/storage.ts"
      to: ".knowledge/schema/pattern.schema.ts"
      via: "import PatternSchema for validation"
      pattern: "import.*PatternSchema.*pattern\\.schema"
    - from: ".knowledge/lib/search.ts"
      to: ".knowledge/lib/storage.ts"
      via: "uses loadPattern to read patterns"
      pattern: "import.*loadPattern.*storage"
---

<objective>
Create storage and search operations for patterns.

Purpose: STOR-01, STOR-03, STOR-04 require saving/loading patterns with validation and tag-based search. This plan implements the core operations.
Output: Storage module with CRUD operations, search module with filtering functions, barrel export for clean API.
</objective>

<execution_context>
@/Users/khairul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/khairul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pattern-storage-foundation/01-RESEARCH.md
@.planning/phases/01-pattern-storage-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage module with CRUD operations</name>
  <files>.knowledge/lib/storage.ts</files>
  <action>
    Create storage module with:

    1. PATTERNS_DIR constant: '.knowledge/patterns'

    2. getPatternPath(category: Category, name: string): string
       - Returns path like '.knowledge/patterns/layout/grid-system.yaml'
       - Slugify name (lowercase, hyphens)

    3. async savePattern(pattern: Pattern): Promise<string>
       - Validate with PatternSchema.parse() BEFORE writing
       - Generate file path from category and name
       - Create directory if needed (mkdir recursive)
       - Stringify to YAML with yaml library
       - Write file
       - Return file path

    4. async loadPattern(filePath: string): Promise<Pattern>
       - Read file
       - Parse YAML with yaml library
       - Validate with PatternSchema.parse()
       - Return typed Pattern

    5. async deletePattern(filePath: string): Promise<void>
       - Delete file if exists
       - No error if file doesn't exist

    6. async listPatterns(category?: Category): Promise<string[]>
       - Use glob to find all .yaml files
       - If category provided, scope to that folder
       - Return array of file paths

    Use yaml library (not js-yaml) per research. Use fs/promises for async file ops.
  </action>
  <verify>
    - npx tsc --noEmit .knowledge/lib/storage.ts (no errors)
    - Functions handle validation errors (throw ZodError)
    - File paths are correct format
  </verify>
  <done>Storage module provides CRUD operations with validation on save and load</done>
</task>

<task type="auto">
  <name>Task 2: Create search module with filtering functions</name>
  <files>.knowledge/lib/search.ts</files>
  <action>
    Create search module with:

    1. async searchByTags(tags: string[]): Promise<Pattern[]>
       - Get all pattern files with listPatterns()
       - Load each pattern
       - Filter to patterns where ALL tags are present
       - Return matching patterns

    2. async filterByCategory(category: Category): Promise<Pattern[]>
       - Use listPatterns(category) to get files
       - Load and return all patterns in category

    3. async filterByFramework(framework: Framework): Promise<Pattern[]>
       - Get all pattern files
       - Load each pattern
       - Filter to patterns that include framework
       - Return matching patterns

    4. async searchPatterns(options: SearchOptions): Promise<Pattern[]>
       - Combined search with optional: tags[], category, framework
       - Apply all filters that are provided
       - Return intersection of results

    SearchOptions type:
    {
      tags?: string[];
      category?: Category;
      framework?: Framework;
    }

    Note: Simple in-memory filtering is fine per research (< 100 patterns).
  </action>
  <verify>
    - npx tsc --noEmit .knowledge/lib/search.ts (no errors)
    - Functions return Pattern[] type
    - Multiple filters can be combined
  </verify>
  <done>Search module provides tag-based search and filtering by category/framework</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export and public API</name>
  <files>.knowledge/lib/index.ts</files>
  <action>
    Create index.ts as the public API:

    // Re-export types
    export type { Pattern, PatternInput } from '../schema/pattern.schema';
    export type { Category, Framework, WcagLevel } from '../schema/categories';
    export { CATEGORIES, FRAMEWORKS, WCAG_LEVELS } from '../schema/categories';

    // Re-export schema for external validation
    export { PatternSchema } from '../schema/pattern.schema';

    // Re-export storage operations
    export { savePattern, loadPattern, deletePattern, listPatterns } from './storage';

    // Re-export search operations
    export { searchByTags, filterByCategory, filterByFramework, searchPatterns } from './search';
    export type { SearchOptions } from './search';

    This provides a clean single import point:
    import { savePattern, searchByTags, Pattern } from '.knowledge/lib';
  </action>
  <verify>
    - npx tsc --noEmit .knowledge/lib/index.ts (no errors)
    - All public types and functions are exported
    - Import from '.knowledge/lib' works
  </verify>
  <done>Barrel export provides clean public API for all storage and search operations</done>
</task>

</tasks>

<verification>
1. TypeScript compiles:
   ```bash
   npx tsc --noEmit .knowledge/lib/*.ts
   ```

2. Integration test (manual or script):
   ```typescript
   import { savePattern, loadPattern, searchByTags } from '.knowledge/lib';

   // Save a pattern
   const path = await savePattern({
     name: 'Test Grid',
     category: 'layout',
     tags: ['grid', 'responsive'],
     frameworks: ['react'],
     principles: ['Use CSS Grid']
   });

   // Load it back
   const loaded = await loadPattern(path);
   console.log(loaded.name); // 'Test Grid'

   // Search by tag
   const results = await searchByTags(['grid']);
   console.log(results.length); // 1
   ```

3. Invalid patterns rejected on save (ZodError thrown)
</verification>

<success_criteria>
- storage.ts exports savePattern, loadPattern, deletePattern, listPatterns
- search.ts exports searchByTags, filterByCategory, filterByFramework, searchPatterns
- index.ts re-exports all public API
- Saving validates pattern before write
- Loading validates pattern after read
- Search returns Pattern[] with matching results
- TypeScript types inferred correctly throughout
</success_criteria>

<output>
After completion, create `.planning/phases/01-pattern-storage-foundation/01-02-SUMMARY.md`
</output>
