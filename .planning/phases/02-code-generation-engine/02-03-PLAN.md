---
phase: 02-code-generation-engine
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - .knowledge/generator/code-generator.ts
  - .knowledge/generator/index.ts
autonomous: true

must_haves:
  truths:
    - "generateCode() compiles pattern data through Handlebars template for specified framework"
    - "Generated code includes pattern name, principles, and category as documentation"
    - "Code generation uses cached compiled templates for performance"
    - "Missing code_examples gracefully falls back to scaffold template"
  artifacts:
    - path: ".knowledge/generator/code-generator.ts"
      provides: "Template compilation and code generation"
      exports: ["generateCode", "loadTemplate"]
    - path: ".knowledge/generator/index.ts"
      provides: "Updated exports including generateCode"
      exports: ["generateCode", "detectFramework"]
  key_links:
    - from: ".knowledge/generator/code-generator.ts"
      to: "./templates/*.hbs"
      via: "readFileSync template loading"
      pattern: "readFileSync.*templates"
    - from: ".knowledge/generator/code-generator.ts"
      to: "handlebars"
      via: "Handlebars.compile"
      pattern: "Handlebars\\.compile"
---

<objective>
Create code generator that compiles Handlebars templates with pattern data to produce framework-specific code.

Purpose: GEN-01 requires code generation from patterns using templates. This module bridges pattern data (from storage) with templates (from Wave 1) to produce output code.
Output: code-generator.ts that exports generateCode(pattern, framework) function.
</objective>

<execution_context>
@/Users/khairul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/khairul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-code-generation-engine/02-RESEARCH.md
@.knowledge/schema/pattern.schema.ts
@.knowledge/generator/framework-detector.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create code generator with template compilation</name>
  <files>.knowledge/generator/code-generator.ts</files>
  <action>
    Create code-generator.ts with:

    1. Imports:
       - Handlebars from 'handlebars'
       - readFileSync from 'fs'
       - join, dirname from 'path'
       - fileURLToPath from 'url' (for __dirname in ESM)
       - Pattern type from '../schema/pattern.schema'
       - Framework type from '../schema/categories'

    2. Template cache:
       - Map<Framework, HandlebarsTemplateDelegate> for compiled templates
       - Load once, reuse for performance

    3. Helper functions:
       - toPascalCase(str: string): string - converts "my pattern name" to "MyPatternName"
       - toSlugCase(str: string): string - converts "My Pattern Name" to "my-pattern-name"

    4. Register Handlebars helpers:
       ```typescript
       Handlebars.registerHelper('pascalCase', toPascalCase);
       Handlebars.registerHelper('slugCase', toSlugCase);
       ```

    5. loadTemplate(framework: Framework): HandlebarsTemplateDelegate
       - Check cache first
       - Read template file from ./templates/{framework}.hbs
       - Compile with Handlebars.compile()
       - Cache and return

    6. generateCode(pattern: Pattern, framework: Framework): string
       - Get compiled template via loadTemplate
       - Build template context from pattern:
         - name: pattern.name
         - pascalName: toPascalCase(pattern.name)
         - slugName: toSlugCase(pattern.name)
         - principles: pattern.principles
         - category: pattern.category
         - tags: pattern.tags
         - accessibility: pattern.accessibility
         - code: pattern.code_examples?.[framework] || null
       - Execute template with context
       - Return generated string

    Include JSDoc documentation for all exports.
    Handle errors gracefully (missing template -> throw descriptive error).
  </action>
  <verify>
    - npx tsc --noEmit .knowledge/generator/code-generator.ts (no errors)
    - File exports generateCode and loadTemplate
  </verify>
  <done>Code generator created with template caching, Handlebars helpers, and pattern context building</done>
</task>

<task type="auto">
  <name>Task 2: Update generator index with code generation exports</name>
  <files>.knowledge/generator/index.ts</files>
  <action>
    Update .knowledge/generator/index.ts to export code generation functions:

    Re-export from code-generator:
    - generateCode function
    - loadTemplate function (for advanced use)

    Update module comment to reflect expanded capabilities.

    Ensure all exports are properly typed.
  </action>
  <verify>
    - npx tsc --noEmit .knowledge/generator/index.ts
    - Import { generateCode, detectFramework } from '.knowledge/generator' works
  </verify>
  <done>Generator index updated with code generation exports</done>
</task>

<task type="auto">
  <name>Task 3: Test code generation with real pattern</name>
  <files>None (verification only)</files>
  <action>
    Create verification script to test generateCode():

    1. Load an existing pattern:
       - Use loadPattern from .knowledge/lib to load css-grid-system.yaml

    2. Generate code for each framework:
       - generateCode(pattern, 'react') -> verify JSX output
       - generateCode(pattern, 'vue') -> verify SFC output
       - generateCode(pattern, 'svelte') -> verify Svelte output
       - generateCode(pattern, 'vanilla') -> verify CSS output

    3. Verify output contains:
       - Pattern name in comment header
       - At least one principle from pattern.principles
       - Actual code from code_examples (not scaffold) since pattern has examples

    4. Test scaffold generation:
       - Create minimal pattern without code_examples
       - Generate -> verify scaffold structure appears

    Run with: npx tsx [script]
    Log results showing all tests pass.
  </action>
  <verify>
    - All framework outputs contain pattern principles
    - Patterns with code_examples inject the actual code
    - Patterns without code_examples generate scaffold
  </verify>
  <done>Code generation verified working for all frameworks with both code injection and scaffold modes</done>
</task>

</tasks>

<verification>
- npx tsc --noEmit .knowledge/generator/*.ts (all files compile)
- generateCode produces valid output for all 4 frameworks
- Template caching works (second call doesn't re-read file)
- Error handling for missing templates
</verification>

<success_criteria>
- generateCode() produces framework-specific code from pattern data
- Templates are compiled once and cached
- Helper functions convert names correctly (PascalCase, slug-case)
- Both code injection and scaffold modes work
- Generated output includes design principles as documentation
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-generation-engine/02-03-SUMMARY.md`
</output>
