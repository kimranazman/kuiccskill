---
phase: 03-pattern-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .knowledge/extractor/css-analyzer.ts
autonomous: true

must_haves:
  truths:
    - "CSS text is parsed into structured AST"
    - "Animation patterns (keyframes, transitions) are identified"
    - "Layout patterns (grid, flexbox) are detected"
    - "Micro-interaction styles (hover, focus) are extracted"
  artifacts:
    - path: ".knowledge/extractor/css-analyzer.ts"
      provides: "CSS parsing and pattern detection"
      exports: ["parseCss", "extractAnimations", "extractLayoutPatterns", "extractInteractions"]
  key_links:
    - from: ".knowledge/extractor/css-analyzer.ts"
      to: "csstree"
      via: "csstree.parse"
      pattern: "csstree\\.parse"
---

<objective>
Create CSS analysis module for extracting animation, layout, and interaction patterns.

Purpose: Parse stylesheet content and identify meaningful design patterns (keyframes, transitions, grid layouts, hover effects).
Output: CSS analyzer that produces structured pattern data from raw CSS text.
</objective>

<execution_context>
@/Users/khairul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/khairul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pattern-extraction/03-RESEARCH.md
@.knowledge/schema/pattern.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CSSTree and create CSS analyzer</name>
  <files>package.json, .knowledge/extractor/css-analyzer.ts</files>
  <action>
Install CSSTree for CSS parsing:
```bash
npm install csstree
npm install -D @types/css-tree
```

Create `.knowledge/extractor/css-analyzer.ts` with:

1. Type definitions:
```typescript
interface AnimationPattern {
  name: string;
  type: 'keyframes' | 'transition';
  duration?: string;
  timingFunction?: string;
  keyframes?: Record<string, Record<string, string>>; // percentage -> properties
}

interface LayoutPattern {
  type: 'grid' | 'flexbox';
  selector: string;
  properties: Record<string, string>;
}

interface InteractionPattern {
  trigger: 'hover' | 'focus' | 'active';
  selector: string;
  effects: Record<string, string>;
}
```

2. `parseCss(cssText: string)` function:
   - Use csstree.parse() to generate AST
   - Return the AST for further processing
   - Handle malformed CSS gracefully (return partial results)

3. `extractAnimations(ast: CssNode)` function:
   - Walk AST looking for @keyframes rules
   - Walk AST looking for declarations with 'animation' or 'transition' properties
   - Parse animation shorthand into components (name, duration, timing)
   - Return array of AnimationPattern objects

4. `extractLayoutPatterns(ast: CssNode)` function:
   - Find rules with display: grid or display: flex
   - Extract grid-template-columns, grid-template-rows, gap
   - Extract flex-direction, justify-content, align-items
   - Return array of LayoutPattern objects with selectors

5. `extractInteractions(ast: CssNode)` function:
   - Find selectors containing :hover, :focus, :active pseudo-classes
   - Extract transform, opacity, color, background changes
   - Return array of InteractionPattern objects
  </action>
  <verify>
Run TypeScript compiler: `npx tsc --noEmit .knowledge/extractor/css-analyzer.ts`
No type errors.
  </verify>
  <done>CSS analyzer module exists with parseCss, extractAnimations, extractLayoutPatterns, extractInteractions functions</done>
</task>

<task type="auto">
  <name>Task 2: Test CSS analyzer with sample CSS</name>
  <files>.knowledge/extractor/css-analyzer.ts</files>
  <action>
Add a test/validation function at the end of css-analyzer.ts (can be removed later):

```typescript
// Validation - run with: npx tsx .knowledge/extractor/css-analyzer.ts
if (require.main === module) {
  const testCss = `
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .button {
      transition: transform 0.2s ease-out;
    }

    .button:hover {
      transform: scale(1.05);
      background-color: #3b82f6;
    }
  `;

  const ast = parseCss(testCss);
  console.log('Animations:', extractAnimations(ast));
  console.log('Layouts:', extractLayoutPatterns(ast));
  console.log('Interactions:', extractInteractions(ast));
}
```

Run the validation and verify:
- fadeIn keyframes detected with opacity values
- .container grid pattern detected with 3-column layout
- .button:hover interaction detected with scale transform
  </action>
  <verify>
Run: `npx tsx .knowledge/extractor/css-analyzer.ts`
Should output structured pattern data for animations, layouts, and interactions.
  </verify>
  <done>CSS analyzer correctly parses and extracts animation, layout, and interaction patterns from sample CSS</done>
</task>

</tasks>

<verification>
1. CSSTree installed in package.json dependencies
2. `.knowledge/extractor/css-analyzer.ts` exists with all four functions
3. TypeScript compiles without errors
4. Validation outputs correct pattern data for test CSS
</verification>

<success_criteria>
- CSSTree dependency added to package.json
- @keyframes rules are detected and parsed into AnimationPattern objects
- Grid and flexbox layouts are identified with their properties
- Hover/focus/active pseudo-class rules are extracted as interactions
- Malformed CSS is handled gracefully without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-extraction/03-02-SUMMARY.md`
</output>
