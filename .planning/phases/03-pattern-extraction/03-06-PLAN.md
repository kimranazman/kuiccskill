---
phase: 03-pattern-extraction
plan: 06
type: execute
wave: 3
depends_on: [03-04, 03-05]
files_modified:
  - skills/kui-design/commands/analyze.md
  - .knowledge/extractor/index.ts
autonomous: true

must_haves:
  truths:
    - "User can invoke :analyze with a URL"
    - "Extraction pipeline runs end-to-end"
    - "Extracted patterns are saved to .knowledge/patterns/"
    - "Case study documentation is generated"
    - "User receives confirmation of saved patterns"
  artifacts:
    - path: "skills/kui-design/commands/analyze.md"
      provides: ":analyze sub-command definition"
      contains: ["Usage", "Workflow", "Output"]
  key_links:
    - from: "skills/kui-design/commands/analyze.md"
      to: ".knowledge/extractor/index.ts"
      via: "import extractor functions"
      pattern: "from.*extractor"
    - from: ".knowledge/extractor/index.ts"
      to: ".knowledge/lib/storage.ts"
      via: "savePattern"
      pattern: "savePattern"
---

<objective>
Create the :analyze sub-command that integrates all extraction modules into a complete workflow.

Purpose: Provide user-facing command to extract patterns from a URL and save them to the knowledge base.
Output: Skill sub-command definition that orchestrates extraction, pattern identification, and storage.
</objective>

<execution_context>
@/Users/khairul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/khairul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pattern-extraction/03-RESEARCH.md
@skills/kui-design/SKILL.md
@skills/kui-design/commands/generate.md
@.knowledge/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create :analyze command definition</name>
  <files>skills/kui-design/commands/analyze.md</files>
  <action>
Create `skills/kui-design/commands/analyze.md` following the structure of generate.md:

```markdown
---
name: analyze
description: Extract design patterns from a website URL. Analyzes HTML/CSS structure, identifies meaningful patterns, and saves them to the knowledge base with case study documentation.
---

# :analyze Command

Extract design patterns from a website using AI-powered analysis.

## Usage

```
/kui-design:analyze <url>
```

## Workflow

### 1. Fetch and Render Page

Use Playwright to render the target page with full JavaScript execution:

```typescript
import { fetchPage, extractComputedStyles, extractStylesheets } from '.knowledge/extractor';

const page = await fetchPage(url);
const styles = await extractComputedStyles(page);
const stylesheets = await extractStylesheets(page);
```

### 2. Analyze CSS Patterns

Parse stylesheets and extract pattern data:

```typescript
import { parseCss, extractAnimations, extractLayoutPatterns, extractInteractions } from '.knowledge/extractor';

const animations = [];
const layouts = [];
const interactions = [];

for (const stylesheet of stylesheets) {
  const ast = parseCss(stylesheet.content);
  animations.push(...extractAnimations(ast));
  layouts.push(...extractLayoutPatterns(ast));
  interactions.push(...extractInteractions(ast));
}
```

### 3. Analyze DOM Structure

Extract page structure and component hierarchy:

```typescript
import { extractHierarchy } from '.knowledge/extractor';

const html = await page.content();
const domHierarchy = extractHierarchy(html);
```

### 4. Identify Patterns

Use AI to identify meaningful patterns from extracted data:

```typescript
import { buildAnalysisContext, identifyPatterns } from '.knowledge/extractor';

const extractionData = {
  url,
  timestamp: new Date().toISOString(),
  styles,
  stylesheets,
  animations,
  layouts,
  interactions,
  domHierarchy
};

const patterns = await identifyPatterns(extractionData);
```

### 5. Save Patterns

Validate and save patterns to knowledge base:

```typescript
import { savePattern } from '.knowledge/lib';

for (const pattern of patterns) {
  const filePath = await savePattern(pattern);
  console.log(`Saved: ${filePath}`);
}
```

### 6. Generate Case Study

Create documentation for the extracted patterns:

```typescript
import { generateCaseStudy } from '.knowledge/extractor';
import { writeFile } from 'fs/promises';

const caseStudy = generateCaseStudy(extractionData, patterns);
const caseStudyPath = `.knowledge/case-studies/${slugify(url)}.md`;
await writeFile(caseStudyPath, caseStudy);
```

### 7. Output

Display summary of extraction results:

```
──────────────────────────────────────────────────
Pattern Extraction Complete: {url}
──────────────────────────────────────────────────

Patterns Found: {count}

- {Pattern 1 Name} (category)
- {Pattern 2 Name} (category)
- {Pattern 3 Name} (category)

Saved to: .knowledge/patterns/
Case study: .knowledge/case-studies/{slug}.md

Use /kui-design:generate to use these patterns.
──────────────────────────────────────────────────
```

## Options

- `--category <name>` — Focus extraction on specific category
- `--dry-run` — Preview patterns without saving
- `--no-case-study` — Skip case study generation

## Examples

```bash
# Basic extraction
/kui-design:analyze https://stripe.com

# Focus on specific category
/kui-design:analyze --category micro-interactions https://linear.app

# Preview without saving
/kui-design:analyze --dry-run https://vercel.com
```

## Error Handling

- Invalid URL: Show error and usage hint
- Page load timeout: Suggest checking URL or network
- No patterns found: Suggest trying different page or category
- Validation errors: Show which patterns failed and why

## Notes

- JavaScript-rendered content is captured (SPAs work)
- External stylesheets may not be accessible due to CORS
- Large sites may take 30-60 seconds to fully analyze
- Patterns are validated against schema before saving
```
  </action>
  <verify>
File exists at `skills/kui-design/commands/analyze.md` with complete command definition.
  </verify>
  <done>:analyze command definition exists with workflow, options, and examples</done>
</task>

<task type="auto">
  <name>Task 2: Update extractor index with orchestration function</name>
  <files>.knowledge/extractor/index.ts</files>
  <action>
Add a high-level orchestration function to `.knowledge/extractor/index.ts`:

```typescript
// Add to existing exports
export { generateCaseStudy } from './case-study';

// Add orchestration function
export async function extractPatternsFromUrl(url: string): Promise<{
  patterns: Pattern[];
  caseStudy: string;
  extractionData: ExtractionData;
}> {
  // 1. Fetch page
  const { page, browser } = await fetchPage(url);

  try {
    // 2. Extract data
    const styles = await extractComputedStyles(page);
    const stylesheets = await extractStylesheets(page);
    const html = await page.content();

    // 3. Analyze CSS
    const animations: AnimationPattern[] = [];
    const layouts: LayoutPattern[] = [];
    const interactions: InteractionPattern[] = [];

    for (const ss of stylesheets) {
      const ast = parseCss(ss.content);
      animations.push(...extractAnimations(ast));
      layouts.push(...extractLayoutPatterns(ast));
      interactions.push(...extractInteractions(ast));
    }

    // 4. Analyze DOM
    const domHierarchy = extractHierarchy(html);

    // 5. Build extraction data
    const extractionData: ExtractionData = {
      url,
      timestamp: new Date().toISOString(),
      styles,
      stylesheets,
      animations,
      layouts,
      interactions,
      domHierarchy
    };

    // 6. Identify patterns (AI-powered)
    const patterns = await identifyPatterns(extractionData);

    // 7. Generate case study
    const caseStudy = generateCaseStudy(extractionData, patterns);

    return { patterns, caseStudy, extractionData };
  } finally {
    await browser.close();
  }
}
```

Export the orchestration function:
```typescript
export { extractPatternsFromUrl };
```
  </action>
  <verify>
Run TypeScript compiler: `npx tsc --noEmit .knowledge/extractor/index.ts`
No type errors. Orchestration function compiles correctly.
  </verify>
  <done>Extractor index includes high-level extractPatternsFromUrl orchestration function</done>
</task>

<task type="auto">
  <name>Task 3: Create case-studies directory and update SKILL.md</name>
  <files>skills/kui-design/SKILL.md, .knowledge/case-studies/.gitkeep</files>
  <action>
1. Create the case-studies directory:
```bash
mkdir -p .knowledge/case-studies
touch .knowledge/case-studies/.gitkeep
```

2. Update `skills/kui-design/SKILL.md` to document the :analyze command:

In the "Available Sub-Commands" section, update:
```markdown
## Available Sub-Commands

- **:generate** — Search patterns and generate framework-specific code
- **:analyze** — Extract design patterns from a website URL
```

In a new section or existing notes:
```markdown
## Extraction Output

When using :analyze, patterns are saved to:
- `.knowledge/patterns/{category}/` — Individual pattern YAML files
- `.knowledge/case-studies/` — Case study documentation for each analyzed site
```
  </action>
  <verify>
Directory exists: `ls .knowledge/case-studies/`
SKILL.md updated with :analyze documentation.
  </verify>
  <done>Case studies directory exists, SKILL.md documents both commands</done>
</task>

</tasks>

<verification>
1. `skills/kui-design/commands/analyze.md` exists with complete workflow
2. Extractor index exports `extractPatternsFromUrl` function
3. Case studies directory exists at `.knowledge/case-studies/`
4. SKILL.md documents the :analyze command
5. All TypeScript compiles without errors
</verification>

<success_criteria>
- User can invoke `/kui-design:analyze <url>`
- Extraction pipeline is fully documented in command definition
- High-level orchestration function handles end-to-end flow
- Output includes saved patterns and case study location
- Error handling covers common failure modes
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-extraction/03-06-SUMMARY.md`
</output>
